# 렌더러 프로세스 아키텍처 리팩토링 (2025-07-26)

이 문서는 렌더러 프로세스의 초기 아키텍처를 개선하고, 향후 확장성 및 모딩(Modding) 생태계의 기반을 다지기 위해 수행된 리팩토링 작업을 기록합니다.

## 1. 목표

- **관심사 분리 (Separation of Concerns):** 거대 파일(`God File`)이었던 `renderer.ts`와 `main-ui.ts`의 역할을 분리하여 각 모듈이 명확한 단일 책임을 갖도록 합니다.
- **결합도 감소 (Decoupling):** 서비스 간의 직접적인 의존성을 줄이고, 전역 `window` 객체 사용을 지양합니다.
- **타입 안정성 강화:** 핵심 통신 메커니즘에 타입을 적용하여 컴파일 타임에 오류를 방지하고 개발자 경험을 향상시킵니다.
- **견고한 기반 마련:** 모딩 시스템이 안전하고 예측 가능하게 코어 시스템과 상호작용할 수 있는 구조를 설계합니다.

## 2. 주요 변경 사항

### 2.1. 서비스 계층 도입 (`main-ui.ts` 분리)

- **문제점:** 기존 `main-ui.ts` 파일은 설정 관리, LLM API 통신, UI 이벤트 리스너 등 너무 많은 책임을 가지고 있었습니다.
- **개선 내용:**
    1.  `main-ui.ts` -> `app-main.ts`로 개명하고, 순수 UI 이벤트 처리 및 패널 관리 역할로 축소했습니다.
    2.  **`SettingsService` (`settings-service.ts`) 생성:** API 키, 페르소나, 배경색 등 모든 애플리케이션 설정의 로드/저장 로직을 이전했습니다.
    3.  **`ChatService` (`chat-service.ts`) 생성:** `sendChatMessage` 함수, 채팅 기록 관리, LLM API 호출 및 응답 처리 로직을 이전했습니다.
- **기대 효과:** 각 서비스의 역할이 명확해져 코드 이해 및 유지보수가 용이해졌습니다.

### 2.2. 타입 지정 이벤트 버스 (`TypedEventBus`) 도입

- **문제점:** 기존 `EventBusImpl`은 타입이 없어 어떤 이벤트가 어떤 데이터(payload)를 전달하는지 알기 어려웠고, 런타임 오류에 취약했습니다.
- **개선 내용:**
    1.  `src/core/event-bus.ts`에 `TypedEventBus`를 새로 구현했습니다.
    2.  `AppEvents` 타입을 통해 애플리케이션 전체에서 사용될 모든 이벤트의 이름과 페이로드 타입을 중앙에서 관리합니다.
    3.  기존 `EventBusImpl`을 사용하는 모든 코드를 새로운 `TypedEventBus`로 교체했습니다.
- **기대 효과:**
    - 이벤트 이름과 페이로드에 대한 자동 완성 및 타입 체크가 가능해져 개발 생산성이 향상됩니다.
    - 시스템 전체의 데이터 흐름을 `AppEvents` 타입 정의만 보고도 파악할 수 있습니다.

### 2.3. 개발 환경 안정화

- **문제점:** `TypedEventBus` 도입 후, `node_modules/@types/node` 내부에서 대량의 타입 에러가 발생했습니다.
- **원인:** 프로젝트에 설정된 `typescript (~4.5.4)` 버전과, 다른 의존성 패키지에 의해 설치된 최신 `@types/node` 버전 간의 호환성 문제였습니다.
- **해결:** `package.json`의 `devDependencies`에 `typescript`와 `@types/node`를 최신 버전으로 명시적으로 설치하여 문제를 해결했습니다.

## 3. 향후 아키텍처 개선 계획 (P0)

현재 진행 중인 리팩토링의 최종 목표는 **Composition Root 패턴**을 도입하여 서비스 간의 의존성을 완전히 제어하고, 전역 `window` 객체 사용을 제거하는 것입니다.

- **`renderer-app.ts` (Composition Root):**
    - 렌더러 프로세스의 메인 진입점 역할을 합니다.
    - `EventBus`, `SceneService`, `VRMManager`, `IpcService` 등 모든 핵심 서비스를 **생성(new)**하고,
    - **생성자 주입(Constructor Injection)**을 통해 각 서비스가 필요로 하는 다른 서비스의 인스턴스를 명시적으로 전달합니다.

- **서비스 분리 계속:**
    - **`SceneService`:** `renderer.ts`의 THREE.js 관련 코드(씬, 카메라, 렌더러, 조명, 메인 루프)를 모두 이전합니다.
    - **`IpcService`:** 메인 프로세스와의 모든 통신(`window.electronAPI.on`)을 담당하며, 수신된 IPC 메시지를 `EventBus`를 통해 다른 서비스에 전파합니다.

이 작업이 완료되면, 각 서비스는 전역 객체가 아닌 명시적으로 주입된 의존성에만 의존하게 되어 테스트가 용이하고 재사용성이 높은 깨끗한 아키텍처가 완성됩니다.
