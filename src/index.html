<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Hello World!</title>
    
  </head>
  <body>
    <button id="close-overlay" style="position: fixed; top: 24px; right: 32px; z-index: 1000; background: rgba(0,0,0,0.5); color: #fff; border: none; border-radius: 4px; font-size: 1.5rem; padding: 0.5rem 1rem; cursor: pointer;">Ã—</button>
    <button id="open-settings" style="position: fixed; top: 24px; right: 80px; z-index: 1000; background: rgba(0,0,0,0.5); color: #fff; border: none; border-radius: 4px; font-size: 1.1rem; padding: 0.5rem 1rem; cursor: pointer;">ì„¤ì •</button>
    <div id="settings-modal" style="display:none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.55); z-index: 2000; align-items: center; justify-content: center;">
      <div class="settings-container">
        <button id="close-settings" style="position: absolute; top: 18px; right: 24px; background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer;">Ã—</button>
        <h2>ì±—ë´‡ LLM API ì„¤ì •</h2>
        <form id="llm-form">
          <label for="llm-api-key">LLM API í‚¤</label>
          <input type="text" id="llm-api-key" name="llm-api-key" placeholder="API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required />
          <button type="submit">ì €ì¥</button>
        </form>
        <div id="save-message" style="display:none; color:green; margin-top:10px;">ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
      </div>
    </div>
    <div id="animation-buttons" style="position: fixed; top: 50%; left: 20px; transform: translateY(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 5px; background-color: rgba(0,0,0,0.3); padding: 10px; border-radius: 5px;">
      <!-- ë””ë²„ê·¸ìš© 'ë¯¸ì†Œ' í‘œì • ë²„íŠ¼ ì¶”ê°€ -->
      <button id="smile-debug-button" style="margin: 5px; padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">ë¯¸ì†Œ í‘œì •</button>
      <!-- ë””ë²„ê·¸ìš© í¬ì¦ˆ ì €ì¥ ë²„íŠ¼ ì¶”ê°€ -->
      <button id="save-pose-button" style="margin: 5px; padding: 10px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">í¬ì¦ˆ ì €ì¥</button>
      <!-- ë””ë²„ê·¸ìš© í¬ì¦ˆ ë¡œë“œ ë²„íŠ¼ ì¶”ê°€ -->
      <button id="load-pose-button" style="margin: 5px; padding: 10px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">í¬ì¦ˆ ë¡œë“œ</button>
      <!-- ë””ë²„ê·¸ìš© ëœë¤ í¬ì¦ˆ ë²„íŠ¼ ì¶”ê°€ -->
      <button id="random-pose-button" style="margin: 5px; padding: 10px; background-color: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">ëœë¤ í¬ì¦ˆ</button>
      <!-- ì• ë‹ˆë©”ì´ì…˜ ë²„íŠ¼ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë  ê²ƒì…ë‹ˆë‹¤. -->
    </div>
    <div id="chat-container">
      <div id="chat-messages"></div>
      <form id="chat-form">
        <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" required />
        <button type="submit">ì „ì†¡</button>
      </form>
    </div>
    <h1>ğŸ’– Hello World!</h1>
    <p>Welcome to your Electron application.</p>
    <script>
      document.getElementById('close-overlay').onclick = () => window.close();
      document.getElementById('open-settings').onclick = () => {
        document.getElementById('settings-modal').style.display = 'flex';
      };
      document.getElementById('close-settings').onclick = () => {
        document.getElementById('settings-modal').style.display = 'none';
      };
      // LLM API ì €ì¥ ë¡œì§
      const form = document.getElementById('llm-form');
      const saveMessage = document.getElementById('save-message');
      form.onsubmit = (e) => {
        e.preventDefault();
        const apiKey = document.getElementById('llm-api-key').value;
        localStorage.setItem('llmApiKey', apiKey);
        saveMessage.style.display = 'block';
        setTimeout(() => { saveMessage.style.display = 'none'; }, 2000);
      };
      document.getElementById('llm-api-key').value = localStorage.getItem('llmApiKey') || '';

      // ì• ë‹ˆë©”ì´ì…˜ ë²„íŠ¼ ìƒì„± ë¡œì§
      const animationButtonsContainer = document.getElementById('animation-buttons');
      console.log('animationButtonsContainer:', animationButtonsContainer);
      if (animationButtonsContainer && window.vrmAnimationList && window.currentVrm && window.mixer) {
        console.log('Creating animation buttons...');
        window.vrmAnimationList.forEach((clip, index) => {
          const button = document.createElement('button');
          button.textContent = clip.name || `Animation ${index}`;
          button.style.margin = '5px';
          button.style.padding = '10px';
          button.style.backgroundColor = '#007bff';
          button.style.color = 'white';
          button.style.border = 'none';
          button.style.borderRadius = '5px';
          button.style.cursor = 'pointer';

          button.onclick = () => {
            window.mixer.stopAllAction(); // ê¸°ì¡´ ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
            const action = window.mixer.clipAction(clip);
            action.play();
            console.log(`Applied animation: ${clip.name || `Animation ${index}`}`);
          };
          animationButtonsContainer.appendChild(button);
          console.log(`Button created for: ${clip.name || `Animation ${index}`}`);
        });
      } else {
        console.warn('Animation list or VRM model/mixer not ready for animation buttons.', { animationButtonsContainer, vrmAnimationList: window.vrmAnimationList, currentVrm: window.currentVrm, mixer: window.mixer });
      }

      

      // ë””ë²„ê·¸ìš© í¬ì¦ˆ ì €ì¥/ë¡œë“œ ë²„íŠ¼ ë¡œì§
      const savePoseButton = document.getElementById('save-pose-button');
      const loadPoseButton = document.getElementById('load-pose-button');
      let savedPose = null;

      if (savePoseButton) {
        savePoseButton.onclick = () => {
          if (window.saveVrmPose) {
            savedPose = window.saveVrmPose();
            if (savedPose) {
              localStorage.setItem('vrmSavedPose', JSON.stringify(savedPose));
              console.log('Pose saved to localStorage.');
            }
          } else {
            console.warn('saveVrmPose function not available.');
          }
        };
      }

      if (loadPoseButton) {
        loadPoseButton.onclick = () => {
          if (window.loadVrmPose) {
            const storedPose = localStorage.getItem('vrmSavedPose');
            if (storedPose) {
              savedPose = JSON.parse(storedPose);
              window.loadVrmPose(savedPose);
              console.log('Pose loaded from localStorage.');
            } else {
              console.warn('No pose found in localStorage.');
            }
          } else {
            console.warn('loadVrmPose function not available.');
          }
        };
      }

      
      const chatForm = document.getElementById('chat-form');
      const chatInput = document.getElementById('chat-input');
      const chatMessages = document.getElementById('chat-messages');
      let chatHistory = [];
      function appendMessage(role, text) {
        const msgDiv = document.createElement('div');
        msgDiv.className = 'chat-message ' + role;
        msgDiv.textContent = (role === 'user' ? 'ğŸ™‹â€â™‚ï¸ ' : 'ğŸ¤– ') + text;
        chatMessages.appendChild(msgDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
      chatForm.onsubmit = async (e) => {
        e.preventDefault();
        const userMsg = chatInput.value.trim();
        if (!userMsg) return;
        appendMessage('user', userMsg);
        chatHistory.push({ role: 'user', parts: [{ text: userMsg }] });
        chatInput.value = '';
        // Gemini API í˜¸ì¶œ
        const apiKey = localStorage.getItem('llmApiKey');
        if (!apiKey) {
          appendMessage('assistant', 'API í‚¤ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ì„¤ì •ì—ì„œ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
          return;
        }
        try {
          const contentsToSend = [
            { role: 'system', parts: [{ text: `ëª¨ë“  ì‘ë‹µì— <í‘œì •: [í‘œì •_ì´ë¦„]> í˜•ì‹ì˜ í‘œì • íƒœê·¸ë¥¼ í¬í•¨í•´ ì£¼ì„¸ìš”. í‘œì •_ì´ë¦„ì€ ë‹¤ìŒ ëª©ë¡ ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•©ë‹ˆë‹¤: ${window.vrmExpressionList ? window.vrmExpressionList.join(', ') : 'ê¸°ë³¸, í–‰ë³µ, ìŠ¬í””'}. ì˜ˆì‹œ: <í‘œì •: í–‰ë³µ> ì•ˆë…•í•˜ì„¸ìš”!` }] },
            ...chatHistory.slice(-10) // ìµœê·¼ 10ê°œë§Œ ë³´ëƒ„
          ];
          console.log('Contents sent to Gemini API:', contentsToSend);
          const res = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + apiKey, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              systemInstruction: { parts: [{ text: `ëª¨ë“  ì‘ë‹µì— <í‘œì •: [í‘œì •_ì´ë¦„]> í˜•ì‹ì˜ í‘œì • íƒœê·¸ë¥¼ í¬í•¨í•´ ì£¼ì„¸ìš”. í‘œì •_ì´ë¦„ì€ ë‹¤ìŒ ëª©ë¡ ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•©ë‹ˆë‹¤: ${window.vrmExpressionList ? window.vrmExpressionList.join(', ') : 'ê¸°ë³¸, í–‰ë³µ, ìŠ¬í””'}. ì˜ˆì‹œ: <í‘œì •: í–‰ë³µ> ì•ˆë…•í•˜ì„¸ìš”!` }] },
              contents: chatHistory.slice(-10), // ìµœê·¼ 10ê°œë§Œ ë³´ëƒ„
            })
          });
          const data = await res.json();
          let text = data.candidates?.[0]?.content?.parts?.[0]?.text || 'ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.';
          let expression = 'ê¸°ë³¸'; // Default expression
          const expressionMatch = text.match(/<í‘œì •:\s*(.*?)\s*>/);
          if (expressionMatch && expressionMatch[1]) {
            const proposedExpression = expressionMatch[1];
            if (window.vrmExpressionList && window.vrmExpressionList.includes(proposedExpression)) {
              expression = proposedExpression;
            } else {
              console.warn(`LLM proposed expression "${proposedExpression}" not found in VRM expression list. Using default "ê¸°ë³¸".`);
            }
            text = text.replace(/<í‘œì •:\s*(.*?)\s*>/, '').trim(); // Remove the expression tag from the text
          }
          console.log('LLM Response Text:', text);
          console.log('LLM Expression:', expression);

          // VRM ëª¨ë¸ì— í‘œì • ì ìš©
          if (window.currentVrm && window.currentVrm.expressionManager && window.expressionMap) {
            console.log('Attempting to apply VRM expression.');
            console.log('window.currentVrm:', window.currentVrm);
            console.log('window.currentVrm.expressionManager:', window.currentVrm.expressionManager);

            // LLMì´ ì œì•ˆí•œ í‘œì •ì„ VRM ëª¨ë¸ì— ì ì§„ì ìœ¼ë¡œ ì ìš©
            if (window.vrmExpressionList.includes(expression)) { // LLMì´ ì œì•ˆí•œ í‘œì •ì´ ìœ íš¨í•œì§€ ë‹¤ì‹œ í™•ì¸
              const vrmInternalName = window.expressionMap[expression];
              if (vrmInternalName) {
                window.animateExpression(vrmInternalName, 1.0, 0.5); // 0.5ì´ˆ ë™ì•ˆ ì ì§„ì ìœ¼ë¡œ ë³€ê²½
                console.log(`Applying VRM expression: ${expression} (Internal: ${vrmInternalName}) with animation`);
              } else {
                console.warn(`VRM internal name not found for mapped expression: ${expression}`);
              }
            } else {
              console.warn(`LLM proposed expression "${expression}" not found in VRM expression list. Not applying.`);
            }
            console.log('VRM expressionManager methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(window.currentVrm.expressionManager)));
          } else {
            console.warn('VRM model or expressionManager not ready for expression application.', { currentVrm: window.currentVrm, expressionManager: window.currentVrm?.expressionManager, expressionMap: window.expressionMap });
          }

          appendMessage('assistant', text);
          chatHistory.push({ role: 'model', parts: [{ text }] });
        } catch (err) {
          appendMessage('assistant', 'Gemini API í˜¸ì¶œ ì‹¤íŒ¨: ' + err);
        }
      };
    </script>
  </body>
</html>
