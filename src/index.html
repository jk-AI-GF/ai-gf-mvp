<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>AiCompanion</title>
    <style>
      .settings-modal-hidden {
        display: none;
      }
      .settings-modal-visible {
        display: block;
      }
    </style>
  </head>
  <body>
    <div id="top-buttons-container" style="position: fixed; top: 24px; right: 32px; z-index: 1000; display: flex; justify-content: flex-end; align-items: center; gap: 10px;">
      <button id="open-settings" style="background: rgba(0,0,0,0.5); color: #fff; border: none; border-radius: 4px; font-size: 1.1rem; padding: 0.5rem 1rem; cursor: pointer;">ì„¤ì •</button>
      <button id="open-joint-control" style="background: rgba(0,0,0,0.5); color: #fff; border: none; border-radius: 4px; font-size: 1.1rem; padding: 0.5rem 1rem; cursor: pointer;">ê´€ì ˆ ì¡°ì ˆ</button>
      <button id="open-expression-panel-button" style="background: rgba(0,0,0,0.5); color: #fff; border: none; border-radius: 4px; font-size: 1.1rem; padding: 0.5rem 1rem; cursor: pointer;">í‘œì •</button>
      <button id="close-overlay" style="background: rgba(0,0,0,0.5); color: #fff; border: none; border-radius: 4px; font-size: 1.5rem; padding: 0.5rem 1rem; cursor: pointer;">Ã—</button>
    </div>
    <div id="settings-modal" style="visibility:hidden; opacity:0; transition: opacity 0.3s ease, visibility 0.3s ease; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 600px; height: 400px; background: rgba(20,20,20,0.95); z-index: 2001; padding: 20px; border-radius: 10px; color: #fff; overflow-y: auto; box-shadow: 0 0 20px rgba(0,0,0,0.5);">
      <button id="close-settings" style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer;">Ã—</button>
      <h2 style="margin-top: 0; margin-bottom: 20px; font-size: 1.8rem; text-align: center;">ì±—ë´‡ LLM API ì„¤ì •</h2>
      <form id="llm-form" style="display: flex; flex-direction: column; gap: 15px;">
        <label for="llm-api-key" style="font-size: 1.1rem; color: #ccc;">LLM API í‚¤</label>
        <input type="text" id="llm-api-key" name="llm-api-key" placeholder="API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required style="padding: 10px; border: 1px solid #444; border-radius: 5px; background-color: #333; color: #eee; font-size: 1rem;" />
        <button type="submit" style="padding: 12px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1rem; transition: background-color 0.2s ease;">ì €ì¥</button>
      </form>
      <h2 style="margin-top: 20px; margin-bottom: 20px; font-size: 1.8rem; text-align: center;">í˜ë¥´ì†Œë‚˜ ì„¤ì •</h2>
      <form id="persona-form" style="display: flex; flex-direction: column; gap: 15px;">
        <label for="persona-text" style="font-size: 1.1rem; color: #ccc;">í˜ë¥´ì†Œë‚˜ í…ìŠ¤íŠ¸</label>
        <textarea id="persona-text" name="persona-text" rows="5" placeholder="í˜ë¥´ì†Œë‚˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="padding: 10px; border: 1px solid #444; border-radius: 5px; background-color: #333; color: #eee; font-size: 1rem; resize: vertical;"></textarea>
        <button type="submit" style="padding: 12px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1rem; transition: background-color 0.2s ease;">ì €ì¥</button>
        <button type="button" id="load-persona-file-button" style="padding: 12px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1rem; transition: background-color 0.2s ease;">íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </form>
      <h2 style="margin-top: 20px; margin-bottom: 20px; font-size: 1.8rem; text-align: center;">ë°°ê²½ ì„¤ì •</h2>
      <form id="background-form" style="display: flex; flex-direction: column; gap: 15px;">
        <label for="background-color-picker" style="font-size: 1.1rem; color: #ccc;">ë°°ê²½ ìƒ‰ìƒ</label>
        <input type="color" id="background-color-picker" name="background-color-picker" value="#36393f" style="width: 100%; height: 40px; border: none; padding: 0;" />
      </form>
      <div id="save-message" style="display:none; color:lightgreen; margin-top:15px; font-size: 0.9rem; text-align: center;">ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
    </div>
    <div id="settings-modal-overlay" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; pointer-events: none;"></div>
    <div id="joint-control-panel" style="display:none; position: fixed; top: 80px; right: 20px; width: 300px; max-height: 70vh; background: rgba(20,20,20,0.8); z-index: 2000; padding: 20px; border-radius: 10px; color: #fff; overflow-y: auto;">
      <button id="close-joint-control" style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer;">Ã—</button>
      <h3>ê´€ì ˆ ì¡°ì ˆ</h3>
      <div id="joint-sliders"></div>
    </div>
    <div id="pose-side-panel" style="display:none; position: fixed; top: 0; right: 0; width: 300px; height: 100vh; background: rgba(30,30,30,0.95); z-index: 2000; padding: 25px; color: #fff; overflow-y: auto; box-shadow: -5px 0 15px rgba(0,0,0,0.5);">
      <button id="close-pose-panel" style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer;">Ã—</button>
      <div id="pose-list-display"></div>
    </div>

    <div id="animation-side-panel" style="display:none; position: fixed; top: 0; right: 0; width: 300px; height: 100vh; background: rgba(30,30,30,0.95); z-index: 2000; padding: 25px; color: #fff; overflow-y: auto; box-shadow: -5px 0 15px rgba(0,0,0,0.5);">
      <button id="close-animation-panel" style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer;">Ã—</button>
      <div id="animation-list-display"></div>
    </div>

    <div id="expression-control-panel" style="display:none; position: fixed; top: 80px; right: 20px; width: 300px; max-height: 70vh; background: rgba(20,20,20,0.8); z-index: 2000; padding: 20px; border-radius: 10px; color: #fff; overflow-y: auto;">
      <button id="close-expression-panel" style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer;">Ã—</button>
      <h3>í‘œì • ì¡°ì ˆ</h3>
      <div id="expression-sliders"></div>
    </div>
    <div id="animation-buttons" style="position: fixed; top: 50%; left: 20px; transform: translateY(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 5px; background-color: rgba(0,0,0,0.3); padding: 10px; border-radius: 0px;">
      <!-- VRM ëª¨ë¸ ê´€ë ¨ -->
      <button id="load-vrm-button" style="padding: 10px; background-color: #34495e; color: white; border: none; border-radius: 0px; cursor: pointer;">VRM ëª¨ë¸ ë¡œë“œ</button>
      
      <!-- í¬ì¦ˆ/ì• ë‹ˆë©”ì´ì…˜ íŒ¨ë„ ì—´ê¸° -->
      <button id="open-pose-panel-button" style="padding: 10px; background-color: #6a9955; color: white; border: none; border-radius: 0px; cursor: pointer;">í¬ì¦ˆ ì—´ê¸°</button>
      <button id="open-animation-panel-button" style="padding: 10px; background-color: #6a9955; color: white; border: none; border-radius: 0px; cursor: pointer;">ì• ë‹ˆë©”ì´ì…˜ ì—´ê¸°</button>

      <!-- í¬ì¦ˆ ê´€ë ¨ -->
      <button id="save-pose-button" style="padding: 10px; background-color: #2c3e50; color: white; border: none; border-radius: 0px; cursor: pointer;">í¬ì¦ˆ ì €ì¥</button>
      <button id="load-pose-file-button" style="padding: 10px; background-color: #2c3e50; color: white; border: none; border-radius: 0px; cursor: pointer;">í¬ì¦ˆ íŒŒì¼ ì—´ê¸°</button>
      <button id="random-pose-button" style="padding: 10px; background-color: #cc6666; color: white; border: none; border-radius: 0px; cursor: pointer;">ëœë¤ í¬ì¦ˆ</button>
    </div>

    <div id="chat-container" style="position: fixed; bottom: 8%; z-index: 9999; border-radius: 5px;">
      <div id="chat-messages" style="margin: 0px;"></div>
      <form id="chat-form">
        <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" required />
        <button type="submit">ì „ì†¡</button>
      </form>
    </div>
    <div id="floating-chat-messages-container" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9998;"></div>
    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        // Initial persona loading
        const personaTextarea = document.getElementById('persona-text');
        const saveMessage = document.getElementById('save-message'); // Get saveMessage here

        const savedPersona = localStorage.getItem('userPersona');
        if (savedPersona) {
          personaTextarea.value = savedPersona;
          window.personaText = savedPersona;
          console.log('Persona loaded from localStorage:', window.personaText);
        } else {
          try {
            const response = await fetch('/main_window/assets/Persona/persona.txt');
            const text = await response.text();
            window.personaText = text.trim();
            personaTextarea.value = window.personaText;
            console.log('Persona loaded from file:', window.personaText);
          } catch (error) {
            console.error('Failed to load persona.txt:', error);
            window.personaText = ''; // Fallback to empty string if loading fails
          }
        }

        document.getElementById('close-overlay').onclick = () => window.close();
        document.getElementById('open-settings').onclick = () => {
          const settingsModal = document.getElementById('settings-modal');
          const settingsOverlay = document.getElementById('settings-modal-overlay');
          settingsModal.style.display = 'block';
          settingsModal.style.visibility = 'visible';
          settingsModal.style.opacity = '1';
          settingsOverlay.style.display = 'block';
          settingsOverlay.style.pointerEvents = 'auto';
        };
        document.getElementById('close-settings').onclick = () => {
          const settingsModal = document.getElementById('settings-modal');
          const settingsOverlay = document.getElementById('settings-modal-overlay');
          settingsModal.style.opacity = '0';
          settingsModal.style.visibility = 'hidden';
          settingsOverlay.style.display = 'none';
          settingsOverlay.style.pointerEvents = 'none';
          // Give time for the transition to complete before setting display to 'none'
          setTimeout(() => {
            settingsModal.style.display = 'none';
          }, 300); // Matches the transition duration
        };
        document.getElementById('open-joint-control').onclick = () => {
          document.getElementById('joint-control-panel').style.display = 'block';
          if (window.createJointSliders) {
            window.createJointSliders();
          }
        };
        document.getElementById('close-joint-control').onclick = () => {
          document.getElementById('joint-control-panel').style.display = 'none';
        };
        // document.getElementById('open-pose-panel-button').onclick = () => {
        //   document.getElementById('pose-side-panel').style.display = 'flex';
        //   // The list will be populated by renderer.ts
        // };
        document.getElementById('close-pose-panel').onclick = () => {
          document.getElementById('pose-side-panel').style.display = 'none';
        };
        document.getElementById('close-animation-panel').onclick = () => {
          document.getElementById('animation-side-panel').style.display = 'none';
        };
        document.getElementById('open-expression-panel-button').onclick = () => {
          const expressionControlPanel = document.getElementById('expression-control-panel');
          if (expressionControlPanel.style.display === 'block') {
            expressionControlPanel.style.display = 'none';
          } else {
            expressionControlPanel.style.display = 'block';
            if (window.createExpressionSliders) {
              window.createExpressionSliders();
            }
          }
        };
        document.getElementById('close-expression-panel').onclick = () => {
          document.getElementById('expression-control-panel').style.display = 'none';
        };
        // LLM API ì €ì¥ ë¡œì§
        const form = document.getElementById('llm-form');
        form.onsubmit = (e) => {
          e.preventDefault();
          const apiKey = document.getElementById('llm-api-key').value;
          localStorage.setItem('llmApiKey', apiKey);
          saveMessage.style.display = 'block';
          setTimeout(() => { saveMessage.style.display = 'none'; }, 2000);
        };
        document.getElementById('llm-api-key').value = localStorage.getItem('llmApiKey') || '';

        // Persona setting
        // Persona setting
        const personaForm = document.getElementById('persona-form');
        const loadPersonaFileButton = document.getElementById('load-persona-file-button');

        personaForm.onsubmit = async (e) => {
          e.preventDefault();
          const persona = personaTextarea.value.trim();
          localStorage.setItem('userPersona', persona);
          window.personaText = persona; // Update window.personaText on save
          saveMessage.style.display = 'block';
          setTimeout(() => { saveMessage.style.display = 'none'; }, 2000);

          // Save persona to file via Electron main process
          try {
            const result = await window.electronAPI.savePersonaToFile(persona);
            if (result.success) {
              console.log(`Persona saved to file: ${result.message}`);
            } else {
              console.error(`Failed to save persona to file: ${result.message}`);
            }
          } catch (error) {
            console.error('Error calling savePersonaToFile:', error);
          }
        };

        loadPersonaFileButton.onclick = async () => {
          try {
            const personaContent = await window.electronAPI.openPersonaFile();
            if (personaContent) {
              personaTextarea.value = personaContent;
              localStorage.setItem('userPersona', personaContent); // Also save to localStorage
              window.personaText = personaContent; // Update window.personaText
              saveMessage.textContent = 'í˜ë¥´ì†Œë‚˜ë¥¼ íŒŒì¼ì—ì„œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!';
              saveMessage.style.display = 'block';
              setTimeout(() => { saveMessage.style.display = 'none'; }, 2000);
            } else {
              saveMessage.textContent = 'í˜ë¥´ì†Œë‚˜ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì·¨ì†Œë¨.';
              saveMessage.style.display = 'block';
              setTimeout(() => { saveMessage.style.display = 'none'; }, 2000);
            }
          } catch (error) {
            console.error('Error loading persona from file:', error);
            saveMessage.textContent = `í˜ë¥´ì†Œë‚˜ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ${error.message}`;
            saveMessage.style.display = 'block';
            setTimeout(() => { saveMessage.style.display = 'none'; }, 2000);
          }
        };

        // Background color setting
        const backgroundColorPicker = document.getElementById('background-color-picker');
        const savedBackgroundColor = localStorage.getItem('backgroundColor');
        if (savedBackgroundColor) {
          backgroundColorPicker.value = savedBackgroundColor;
          if (window.setClearColor) {
            window.setClearColor(parseInt(savedBackgroundColor.replace('#', '0x')));
          }
        }

        backgroundColorPicker.onchange = (e) => {
          const color = e.target.value;
          localStorage.setItem('backgroundColor', color);
          if (window.setClearColor) {
            window.setClearColor(parseInt(color.replace('#', '0x')));
          }
        };
        
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        let chatHistory = [];
        function appendMessage(role, text) {
          const chatMessages = document.getElementById('chat-messages');
          if (role === 'assistant') {
            const floatingContainer = document.getElementById('floating-chat-messages-container');
            if (floatingContainer) {
              const msgDiv = document.createElement('div');
              msgDiv.className = 'floating-chat-message assistant';
              msgDiv.textContent = text;
              Object.assign(msgDiv.style, {
                position: 'absolute',
                background: 'rgba(0, 0, 0, 0.7)',
                color: 'white',
                padding: '8px 12px',
                borderRadius: '15px',
                maxWidth: '250px',
                textAlign: 'center',
                pointerEvents: 'none',
                opacity: '1',
                transition: 'opacity 0.5s ease-out',
                transform: 'translate(-50%, -100%)', // Center above the head
                whiteSpace: 'pre-wrap', // Preserve whitespace and allow wrapping
                wordBreak: 'break-word', // Break long words
              });
              floatingContainer.appendChild(msgDiv);
              window.floatingMessages.push({ element: msgDiv, timestamp: performance.now() }); // window.floatingMessages ì‚¬ìš©
            }
          } else {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'chat-message ' + role;
            msgDiv.textContent = (role === 'user' ? 'ğŸ™‹â€â™‚ï¸ ' : 'ğŸ¤– ') + text;
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }
        }
        chatForm.onsubmit = async (e) => {
          e.preventDefault();
          const userMsg = chatInput.value.trim();
          if (!userMsg) return;
          appendMessage('user', userMsg);
          chatHistory.push({ role: 'user', parts: [{ text: userMsg }] });
          chatInput.value = '';
          // Gemini API í˜¸ì¶œ
          const apiKey = localStorage.getItem('llmApiKey');
          if (!apiKey) {
            appendMessage('assistant', 'API í‚¤ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ì„¤ì •ì—ì„œ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
            return;
          }
          try {
            const contentsToSend = [
              { role: 'system', parts: [{ text: `${window.personaText}\nëª¨ë“  ì‘ë‹µì— <í‘œì •: [í‘œì •_ì´ë¦„]> í˜•ì‹ì˜ í‘œì • íƒœê·¸ë¥¼ í¬í•¨í•´ ì£¼ì„¸ìš”. í‘œì •_ì´ë¦„ì€ ë‹¤ìŒ ëª©ë¡ ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•©ë‹ˆë‹¤: ${window.vrmExpressionList ? window.vrmExpressionList.join(', ') : 'ê¸°ë³¸, í–‰ë³µ, ìŠ¬í””'}. ì˜ˆì‹œ: <í‘œì •: í–‰ë³µ> ì•ˆë…•í•˜ì„¸ìš”!` }] },
              ...chatHistory.slice(-10) // ìµœê·¼ 10ê°œë§Œ ë³´ëƒ„
            ];
            console.log('Contents sent to Gemini API:', contentsToSend);
            const res = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + apiKey, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                systemInstruction: { parts: [{ text: `${window.personaText}\nëª¨ë“  ì‘ë‹µì— <í‘œì •: [í‘œì •_ì´ë¦„]> í˜•ì‹ì˜ í‘œì • íƒœê·¸ë¥¼ í¬í•¨í•´ ì£¼ì„¸ìš”. í‘œì •_ì´ë¦„ì€ ë‹¤ìŒ ëª©ë¡ ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•©ë‹ˆë‹¤: ${window.vrmExpressionList ? window.vrmExpressionList.join(', ') : 'ê¸°ë³¸, í–‰ë³µ, ìŠ¬í””'}. ì˜ˆì‹œ: <í‘œì •: í–‰ë³µ> ì•ˆë…•í•˜ì„¸ìš”!` }] },
                contents: chatHistory.slice(-10), // ìµœê·¼ 10ê°œë§Œ ë³´ëƒ„
              })
            });
            const data = await res.json();
            let text = data.candidates?.[0]?.content?.parts?.[0]?.text || 'ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.';
            let expression = 'ê¸°ë³¸'; // Default expression
            const expressionMatch = text.match(/<í‘œì •:\s*(.*?)\s*>/);
            if (expressionMatch && expressionMatch[1]) {
              const proposedExpression = expressionMatch[1];
              if (window.vrmExpressionList && window.vrmExpressionList.includes(proposedExpression)) {
                expression = proposedExpression;
              } else {
                console.warn(`LLM proposed expression "${proposedExpression}" not found in VRM expression list. Using default "ê¸°ë³¸".`);
              }
              text = text.replace(/<í‘œì •:\s*(.*?)\s*>/, '').trim(); // Remove the expression tag from the text
            }
            console.log('LLM Response Text:', text);
            console.log('LLM Expression:', expression);

            // VRM ëª¨ë¸ì— í‘œì • ì ìš©
            if (window.currentVrm && window.currentVrm.expressionManager && window.expressionMap) {
              console.log('Attempting to apply VRM expression.');
              console.log('window.currentVrm:', window.currentVrm);
              console.log('window.currentVrm.expressionManager:', window.currentVrm.expressionManager);

              // LLMì´ ì œì•ˆí•œ í‘œì •ì„ VRM ëª¨ë¸ì— ì ì§„ì ìœ¼ë¡œ ì ìš©
              if (window.vrmExpressionList.includes(expression)) { // LLMì´ ì œì•ˆí•œ í‘œì •ì´ ìœ íš¨í•œì§€ ë‹¤ì‹œ í™•ì¸
                const vrmInternalName = window.expressionMap[expression];
                if (vrmInternalName) {
                  window.animateExpression(vrmInternalName, 1.0, 0.5); // 0.5ì´ˆ ë™ì•ˆ ì ì§„ì ìœ¼ë¡œ ë³€ê²½
                  console.log(`Applying VRM expression: ${expression} (Internal: ${vrmInternalName}) with animation`);
                } else {
                  console.warn(`VRM internal name not found for mapped expression: ${expression}`);
                }
              } else {
                console.warn(`LLM proposed expression "${expression}" not found in VRM expression list. Not applying.`);
              }
              console.log('VRM expressionManager methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(window.currentVrm.expressionManager)));
            } else {
              console.warn('VRM model or expressionManager not ready for expression application.', { currentVrm: window.currentVrm, expressionManager: window.currentVrm?.expressionManager, expressionMap: window.expressionMap });
            }

            appendMessage('assistant', text);
            
            // --- TTS ì¬ìƒ í˜¸ì¶œ ì¶”ê°€ ---
            if (window.playTTS) {
              window.playTTS(text);
            }
            // --- TTS ì¬ìƒ í˜¸ì¶œ ì¶”ê°€ ë ---

            chatHistory.push({ role: 'model', parts: [{ text }] });
          } catch (err) {
            appendMessage('assistant', 'Gemini API í˜¸ì¶œ ì‹¤íŒ¨: ' + err);
          }
        };
      });
    </script>
  </body>
</html>
